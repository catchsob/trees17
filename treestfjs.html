<title>Trees TF.js</title>
<div id="select">Image: <input type="file" id="select_img" accept="image/*, capture=camera" onchange="preview()"></div>
<div id="result">Prediction: <label id="pred"></label>/ Confidence: <label id="conf"></label></div>
<br>
<img id="preview_img" /><br>

<style type="text/css">
    div, input {
        font-size: 4vw;
    }
    #select, #result {
        white-space: nowrap;
    }
    label {
        color: brown;
    }
    img {
        width: 100vmin;
        height: 100vmin;
    }
    img[src=""], img:not([src]){
        opacity:0;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>

<script>
    const MODEL_NAME = 'YOUR_MODEL_TFJS';
    const ENV = 'env.json'
    const LABELS_NAME = 'YOUR_LABELS';
    const IMAGE_SIZE = 448;
    let model;
    let labels;
    
    function preview() {
        if (!window.FileReader) {
            console.log('no preview functionality supported by your browser!');
            return;
        }
        
        let reader = new FileReader();
        reader.onload = function (event) {
            let img = document.getElementById("preview_img");
            img.src = event.target.result;
            img.onload = () => {  // wait for img be loaded, or img will be all zeros
                predict(img);
            }
        };

        let file = document.getElementById("select_img").files[0];
        if (file != null) { // prevent from cancel while selecting pic
            reader.readAsDataURL(file);
        }
    }
    
    async function init() {
        console.log('start ...')
        const env = await fetchFile(ENV, json=true);
        console.log(ENV + " loaded: ", env);
        labels = (await fetchFile(env[LABELS_NAME])).split("\r\n");
        console.log(env[LABELS_NAME] + ' loaded: ' + labels);
        model = await tf.loadGraphModel(env[MODEL_NAME]);
        console.log(env[MODEL_NAME] + ' loaded.');
    }
    
    async function predict(imgElement) {
        const logits = tf.tidy(() => {
            const img = tf.cast(tf.browser.fromPixels(imgElement).resizeBilinear([IMAGE_SIZE, IMAGE_SIZE]), 'float32');
            const offset = tf.scalar(255.0);
            const normalized = img.div(offset);
            const batched = normalized.reshape([1, IMAGE_SIZE, IMAGE_SIZE, 3]);
            return model.predict(batched);
        });
        
        const values = await logits.data();
        let p = -1;
        let v = -0.1;
        for (let i = 0; i < values.length; i++) {
            if (values[i] > v) {
                v = values[i];
                p = i
            }
        }
        document.getElementById("pred").innerHTML = labels[p]
        document.getElementById("conf").innerHTML = v.toPrecision(4)
        console.log({value: v, index: p, label: labels[p]});
        logits.dispose(); // prevent from WebGL memory leak
    }
    
    const fetchFile = (fileName, json=false) => {
        return fetch(fileName)
            .then((res) => {
                if (res.status == 200) {
                    return json ? res.json() : res.text();
                }
                else {
                    return res.statusText;
                }
            })
            .catch((err) => {
                console.log("Error:", err);
                return err;
            });
    }
    
    init().then(() => {
        console.log('init finished!')
    });
</script>